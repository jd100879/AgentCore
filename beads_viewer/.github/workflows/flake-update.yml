name: Flake Update

on:
  schedule:
    # Weekly on Sunday at 00:00 UTC
    - cron: "0 0 * * 0"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: flake-update
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@e50d5f73bfe71c2dd0aa4218de8f4ade1f4f92d0 # v16

      - name: Configure Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@87e8236f46702ab0ce5a058b605a173ec88d618e # v8

      - name: Update flake inputs
        id: update
        run: |
          # Capture current lock state
          OLD_REV=$(nix flake metadata --json 2>/dev/null | jq -r '.locks.nodes.nixpkgs.locked.rev // "none"')

          # Update all inputs
          nix flake update

          # Check if anything changed
          if git diff --quiet flake.lock; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No updates available"
          else
            NEW_REV=$(nix flake metadata --json | jq -r '.locks.nodes.nixpkgs.locked.rev')
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "old_rev=${OLD_REV:0:8}" >> "$GITHUB_OUTPUT"
            echo "new_rev=${NEW_REV:0:8}" >> "$GITHUB_OUTPUT"
            echo "Updated nixpkgs: ${OLD_REV:0:8} -> ${NEW_REV:0:8}"
          fi

      - name: Verify build
        if: steps.update.outputs.changed == 'true'
        run: |
          # Build to verify the update doesn't break anything
          nix build .#bv --no-link

      - name: Create Pull Request
        if: steps.update.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(nix): update flake inputs"
          title: "chore(nix): update flake inputs"
          body: |
            Automated flake input update.

            **Changes:**
            - nixpkgs: `${{ steps.update.outputs.old_rev }}` â†’ `${{ steps.update.outputs.new_rev }}`

            Build verified successfully.
          branch: flake-update
          delete-branch: true
          labels: dependencies,nix
